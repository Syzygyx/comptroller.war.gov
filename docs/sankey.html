<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Flow - Sankey Diagram</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px 40px;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        nav {
            background: #f8f9fa;
            padding: 15px 40px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        nav a {
            color: #495057;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 5px;
            transition: all 0.3s;
        }

        nav a:hover, nav a.active {
            background: #667eea;
            color: white;
        }

        .controls {
            padding: 30px 40px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .control-group {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-item label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9em;
        }

        .control-item select,
        .control-item input {
            padding: 8px 15px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 0.95em;
            min-width: 150px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        #sankeyChart {
            padding: 20px;
            min-height: 700px;
        }

        .stats-panel {
            padding: 30px 40px;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #667eea;
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .info-box h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .info-box p {
            color: #495057;
            line-height: 1.6;
        }

        footer {
            background: #f8f9fa;
            padding: 20px;
            text-align: center;
            color: #6c757d;
            border-top: 1px solid #dee2e6;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üí∞ Budget Flow Visualization</h1>
            <p>Interactive Sankey diagram showing DoD appropriation flows</p>
        </header>

        <nav>
            <a href="index.html">Dashboard</a>
            <a href="browse.html">Browse Data</a>
            <a href="progress.html">Processing Log</a>
            <a href="chat.html">Chat</a>
            <a href="sankey.html" class="active">Budget Flow</a>
        </nav>

        <div class="controls">
            <h3 style="margin-bottom: 15px; color: #2c3e50;">Visualization Controls</h3>
            <div class="control-group">
                <div class="control-item">
                    <label for="fiscalYear">Fiscal Year</label>
                    <select id="fiscalYear">
                        <option value="all">All Years</option>
                        <option value="2025" selected>FY 2025</option>
                        <option value="2024">FY 2024</option>
                        <option value="2023">FY 2023</option>
                        <option value="2022">FY 2022</option>
                    </select>
                </div>

                <div class="control-item">
                    <label for="minAmount">Minimum Amount ($000s)</label>
                    <input type="number" id="minAmount" value="10000" min="0" step="1000">
                </div>

                <div class="control-item">
                    <label for="flowType">Flow Type</label>
                    <select id="flowType">
                        <option value="category-branch" selected>Category ‚Üí Branch ‚Üí Activity</option>
                        <option value="branch-category">Branch ‚Üí Category ‚Üí Activity</option>
                        <option value="year-branch">Year ‚Üí Branch ‚Üí Category</option>
                    </select>
                </div>

                <button class="btn" onclick="updateDiagram()">Update Diagram</button>
            </div>

            <div class="info-box" style="margin-top: 20px;">
                <h3>‚ÑπÔ∏è How to Read This Diagram</h3>
                <p>
                    <strong>Sankey diagrams</strong> show flows between categories. The width of each flow represents the relative amount of funding. 
                    Hover over any node or link to see exact dollar amounts. Click and drag nodes to rearrange the layout.
                </p>
            </div>
        </div>

        <div id="sankeyChart">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading budget data...</p>
            </div>
        </div>

        <div class="stats-panel">
            <h3 style="margin-bottom: 20px; color: #2c3e50;">Budget Statistics</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalAmount">$0</div>
                    <div class="stat-label">Total Reprogramming</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="categoryCount">0</div>
                    <div class="stat-label">Appropriation Categories</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="branchCount">0</div>
                    <div class="stat-label">Military Branches</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activityCount">0</div>
                    <div class="stat-label">Budget Activities</div>
                </div>
            </div>
        </div>

        <footer>
            <p>Data source: <a href="https://comptroller.defense.gov" target="_blank">comptroller.defense.gov</a></p>
            <p>Visualization powered by Plotly.js</p>
        </footer>
    </div>

    <script>
        let budgetData = [];
        let allFlows = [];

        // Load real budget flow data
        async function loadBudgetData() {
            try {
                const response = await fetch('data/budget_flows.json');
                if (response.ok) {
                    const data = await response.json();
                    allFlows = data.flows || [];
                    console.log(`Loaded ${allFlows.length} budget flows`);
                    updateDiagram();
                    return;
                }
            } catch (error) {
                console.error('Error loading budget flows:', error);
            }
            
            // Fallback to sample data
            console.log('Using sample data');
            allFlows = sampleData;
            updateDiagram();
        }

        // Sample data for fallback
        const sampleData = [
            // Category ‚Üí Branch flows
            { source: 'Operation and Maintenance', target: 'Army', value: 118600, fy: '2025' },
            { source: 'Operation and Maintenance', target: 'Navy', value: 85000, fy: '2025' },
            { source: 'Operation and Maintenance', target: 'Air Force', value: 95000, fy: '2025' },
            { source: 'Operation and Maintenance', target: 'Defense-Wide', value: 657584, fy: '2024' },
            
            { source: 'Weapons Procurement', target: 'Navy', value: 105252, fy: '2025' },
            { source: 'Weapons Procurement', target: 'Air Force', value: 45000, fy: '2025' },
            
            { source: 'Missile Procurement', target: 'Air Force', value: 77482, fy: '2025' },
            { source: 'Missile Procurement', target: 'Navy', value: 62000, fy: '2025' },
            
            { source: 'Procurement', target: 'Defense-Wide', value: 356250, fy: '2025' },
            { source: 'Procurement', target: 'Army', value: 125000, fy: '2024' },
            
            { source: 'RDTE', target: 'Air Force', value: 55000, fy: '2024' },
            { source: 'RDTE', target: 'Navy', value: 48000, fy: '2024' },
            
            // Branch ‚Üí Activity flows
            { source: 'Army', target: 'Operating Forces', value: 118600, fy: '2025' },
            { source: 'Army', target: 'Training & Recruiting', value: 85000, fy: '2024' },
            
            { source: 'Navy', target: 'Other Missiles', value: 105252, fy: '2025' },
            { source: 'Navy', target: 'Ship Operations', value: 95000, fy: '2024' },
            
            { source: 'Air Force', target: 'Other Missiles', value: 77482, fy: '2025' },
            { source: 'Air Force', target: 'Aircraft Operations', value: 115000, fy: '2024' },
            
            { source: 'Defense-Wide', target: 'Major Equipment', value: 356250, fy: '2025' },
            { source: 'Defense-Wide', target: 'Administration', value: 657584, fy: '2024' },
        ];

        function updateDiagram() {
            const fiscalYear = document.getElementById('fiscalYear').value;
            const minAmount = parseFloat(document.getElementById('minAmount').value) || 0;
            const flowType = document.getElementById('flowType').value;

            // Use real data if available, otherwise sample
            budgetData = allFlows.length > 0 ? allFlows.map(f => ({
                source: f.source,
                target: f.target,
                value: f.value,
                fy: f.fiscal_years ? f.fiscal_years[0] : '2025',
                type: f.type
            })) : sampleData;

            // Filter data
            let filtered = budgetData.filter(d => {
                if (fiscalYear !== 'all' && d.fy !== fiscalYear) return false;
                if (d.value < minAmount) return false;
                return true;
            });

            // Build Sankey data
            const nodes = new Set();
            const links = [];

            filtered.forEach(d => {
                nodes.add(d.source);
                nodes.add(d.target);
            });

            const nodeArray = Array.from(nodes);
            const nodeMap = {};
            nodeArray.forEach((node, i) => {
                nodeMap[node] = i;
            });

            filtered.forEach(d => {
                links.push({
                    source: nodeMap[d.source],
                    target: nodeMap[d.target],
                    value: d.value,
                    label: `$${(d.value / 1000).toFixed(1)}M`
                });
            });

            // Create Sankey diagram
            const data = [{
                type: 'sankey',
                orientation: 'h',
                node: {
                    pad: 15,
                    thickness: 30,
                    line: {
                        color: 'black',
                        width: 0.5
                    },
                    label: nodeArray,
                    color: nodeArray.map((_, i) => {
                        // Color by category
                        if (i < 6) return '#667eea'; // Categories
                        if (i < 11) return '#764ba2'; // Branches
                        return '#48bb78'; // Activities
                    }),
                    customdata: nodeArray.map((node, i) => {
                        const total = links
                            .filter(l => l.source === i || l.target === i)
                            .reduce((sum, l) => sum + l.value, 0);
                        return `Total: $${(total / 1000).toFixed(1)}M`;
                    }),
                    hovertemplate: '<b>%{label}</b><br>%{customdata}<extra></extra>'
                },
                link: {
                    source: links.map(l => l.source),
                    target: links.map(l => l.target),
                    value: links.map(l => l.value),
                    color: links.map(() => 'rgba(102, 126, 234, 0.3)'),
                    customdata: links.map(l => l.label),
                    hovertemplate: '%{customdata}<br>%{source.label} ‚Üí %{target.label}<extra></extra>'
                }
            }];

            const layout = {
                title: {
                    text: `DoD Budget Flow ${fiscalYear !== 'all' ? 'FY ' + fiscalYear : 'All Years'}`,
                    font: { size: 20, color: '#2c3e50' }
                },
                font: { size: 12 },
                height: 700,
                margin: { l: 20, r: 20, t: 60, b: 20 }
            };

            const config = {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ['lasso2d', 'select2d'],
                displaylogo: false
            };

            Plotly.newPlot('sankeyChart', data, layout, config);

            // Update statistics
            updateStatistics(filtered);
        }

        function updateStatistics(data) {
            const total = data.reduce((sum, d) => sum + d.value, 0);
            const categories = new Set(data.map(d => d.source)).size;
            const branches = new Set(data.map(d => d.target)).size;
            const activities = data.length;

            document.getElementById('totalAmount').textContent = 
                `$${(total / 1000000).toFixed(2)}B`;
            document.getElementById('categoryCount').textContent = categories;
            document.getElementById('branchCount').textContent = branches;
            document.getElementById('activityCount').textContent = activities;
        }

        // Load data on page load
        loadBudgetData();
    </script>
</body>
</html>
